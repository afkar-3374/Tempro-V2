<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempro Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for graphing -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <!-- Paho MQTT client for browser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-900 text-white;
        }
        .online-status {
            animation: pulse-green 2s infinite;
        }
        @keyframes pulse-green {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col min-h-screen">

    <header class="bg-gray-800 shadow-lg py-4">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">Tempro Dashboard</h1>
        </div>
    </header>

    <main class="flex-grow p-8 flex items-center justify-center">
        <!-- Main Content Card -->
        <div class="max-w-7xl w-full bg-gray-800 rounded-3xl p-8 shadow-2xl">
            <!-- Dashboard Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Live Sensor Temperatures Graph -->
                <div class="lg:col-span-2 bg-gray-900 p-6 rounded-2xl shadow-inner border border-gray-700">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-200">Live Sensor Temperatures</h2>
                        <div class="flex items-center text-green-400">
                            <span class="online-status w-2 h-2 rounded-full mr-2 bg-green-500"></span>
                            <span class="text-sm font-medium">Live Temperatures</span>
                        </div>
                    </div>
                    <div class="h-96">
                        <canvas id="tempChart" class="w-full h-full"></canvas>
                    </div>
                </div>

                <!-- Online Sensors Section -->
                <div class="lg:col-span-1 bg-gray-900 p-6 rounded-2xl shadow-inner border border-gray-700">
                    <div class="border-b border-gray-700 pb-4 mb-4">
                        <h2 class="text-2xl font-semibold text-gray-200">Online Sensors</h2>
                    </div>
                    <div id="online-sensors-list" class="space-y-4">
                        <!-- Sensor status cards will be dynamically added here -->
                    </div>
                    <div class="mt-6 text-sm text-gray-400 text-right" id="last-updated">
                        Last updated: --
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="py-4 text-center text-gray-400 text-sm">
        <p>&copy; 2024 Tempro Dashboard. All rights reserved.</p>
    </footer>

    <script>
        // --- MQTT Client Configuration ---
        const mqttServer = "broker.hivemq.com";
        const mqttPort = 8884; // Using wss:// protocol for secure WebSocket connection
        const mqttClientId = "web-client-" + Math.random().toString(16).substr(2, 8);
        const units = ['unit-1', 'unit-2', 'unit-3', 'unit-4'];
        
        let client;

        // Data storage for live updates and the graph
        const sensorData = {
            'unit-1': { temp: 0, humidity: 0, status: 'Offline' },
            'unit-2': { temp: 0, humidity: 0, status: 'Offline' },
            'unit-3': { temp: 0, humidity: 0, status: 'Offline' },
            'unit-4': { temp: 0, humidity: 0, status: 'Offline' }
        };

        // --- Chart.js Configuration ---
        const ctx = document.getElementById('tempChart').getContext('2d');
        const tempChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: units.map(u => u.split('-').join(' ')),
                datasets: [{
                    label: 'Live Temperature',
                    data: [0, 0, 0, 0],
                    fill: 'start',
                    backgroundColor: 'rgba(59, 130, 246, 0.2)', // blue-500 with alpha
                    borderColor: '#3b82f6', // blue-500
                    borderWidth: 2,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: '#3b82f6',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'white'
                        }
                    },
                    y: {
                        beginAtZero: false,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'white'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                },
                elements: {
                    line: {
                        cubicInterpolationMode: 'monotone'
                    }
                }
            }
        });

        // --- UI Update Functions ---
        function updateUI() {
            updateOnlineSensorsList();
            updateChart();
            updateLastUpdatedTime();
        }

        function updateOnlineSensorsList() {
            const list = document.getElementById('online-sensors-list');
            list.innerHTML = '';
            units.forEach(unit => {
                const data = sensorData[unit];
                const isOnline = data.status === 'Online';
                const card = `
                    <div class="bg-gray-700 p-4 rounded-xl flex justify-between items-center transition-transform duration-200 hover:scale-105 ${isOnline ? 'border-l-4 border-green-500' : 'border-l-4 border-red-500'}">
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full mr-2 ${isOnline ? 'bg-green-500 animate-pulse' : 'bg-red-500'}"></div>
                            <span class="font-semibold">${unit.split('-').join(' ')}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-green-400 font-medium">${isOnline ? 'Online' : 'Offline'}</span>
                            <div class="text-sm">
                                <span class="text-gray-200">${data.temp.toFixed(1)}Â°C</span>
                                ${isOnline ? `<span class="text-green-400 pl-1">+${(data.humidity/10).toFixed(1)}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                list.innerHTML += card;
            });
        }

        function updateChart() {
            const temps = units.map(unit => sensorData[unit].temp);
            tempChart.data.datasets[0].data = temps;
            tempChart.update();
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const dateString = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            document.getElementById('last-updated').textContent = `Last updated: ${dateString} - ${timeString}`;
        }

        // --- MQTT Connection & Message Handling ---
        function connectMQTT() {
            console.log("Connecting to MQTT broker...");
            client = new Paho.Client(mqttServer, Number(mqttPort), mqttClientId);

            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            client.connect({
                useSSL: true,
                onSuccess: onConnect,
                onFailure: onFailure
            });
        }

        function onConnect() {
            console.log("Connected to MQTT broker.");
            // Subscribe to all temperature and humidity topics for all units
            units.forEach(unit => {
                const mqttUnit = unit.split('-').join('');
                client.subscribe(`tempro/${mqttUnit}/temp`);
                client.subscribe(`tempro/${mqttUnit}/humidity`);
            });
        }

        function onFailure(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Connection failed: " + responseObject.errorMessage);
                setTimeout(connectMQTT, 5000); // Retry connection
            }
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Connection lost: " + responseObject.errorMessage);
                units.forEach(unit => {
                    sensorData[unit].status = 'Offline';
                });
                updateUI();
                setTimeout(connectMQTT, 5000); // Attempt to reconnect
            }
        }

        function onMessageArrived(message) {
            const topic = message.destinationName;
            const payload = message.payloadString;
            const [project, unitId, type] = topic.split('/');
            
            if (unitId && type) {
                const internalUnitName = `unit-${unitId.slice(-1)}`;
                const value = parseFloat(payload);

                if (!isNaN(value)) {
                    if (type === 'temp') {
                        sensorData[internalUnitName].temp = value;
                    } else if (type === 'humidity') {
                        sensorData[internalUnitName].humidity = value;
                    }
                    sensorData[internalUnitName].status = 'Online';
                    updateUI();
                }
            }
        }

        // Initialize the app
        window.onload = function() {
            connectMQTT();
        }
    </script>
</body>
</html>
